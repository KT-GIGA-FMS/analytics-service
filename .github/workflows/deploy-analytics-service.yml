name: Deploy analytics-service (Docker Hub + App Service)

on:
  push:
    branches: "deploy"
    paths:
      - "src/**"
      - "build.gradle"
      - "Dockerfile"
      - ".github/workflows/deploy-analystics-service.yml"
  workflow_dispatch:

env:
  IMAGE_NAME: rlfrkdms1/analytics-service   # <-- Docker Hub ë¦¬í¬ì§€í† ë¦¬
  RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag
        id: vars
        run: echo "TAG=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Docker Hub login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push (Docker Hub)
        run: |
          docker build -t $IMAGE_NAME:${{ steps.vars.outputs.TAG }} .
          docker tag  $IMAGE_NAME:${{ steps.vars.outputs.TAG }} $IMAGE_NAME:latest
          docker push $IMAGE_NAME:${{ steps.vars.outputs.TAG }}
          docker push $IMAGE_NAME:latest

      # Azure Web Appì— Docker ì´ë¯¸ì§€ ë°°í¬
      - name: Deploy to Azure Web App (container)
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE }}
          images: index.docker.io/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.TAG }}

      # í™˜ê²½ë³€ìˆ˜ ì„¤ì • (ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´)
      - name: Set environment variables
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE }}
          app-settings: |
            SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}
            SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}

      # ë°°í¬ ì™„ë£Œ í›„ ëŒ€ê¸°
      - name: Wait for deployment
        run: |
          echo "ë°°í¬ ì™„ë£Œ í›„ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘..."
          sleep 60

      # í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰
      - name: Health check
        run: |
          # App Service URL ê°€ì ¸ì˜¤ê¸°
          APP_URL=$(az webapp show \
            -g "$RESOURCE_GROUP" -n "${{ secrets.AZURE_WEBAPP_NAME }}" \
            --query "defaultHostName" -o tsv)
          
          echo "App Service URL: https://$APP_URL"
          
          # í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰
          for i in {1..10}; do
            if curl -f "https://$APP_URL/actuator/health" > /dev/null 2>&1; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
              break
            else
              echo "â³ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘... ($i/10)"
              sleep 15
            fi
          done
          
          # ìµœì¢… í—¬ìŠ¤ì²´í¬
          if ! curl -f "https://$APP_URL/actuator/health" > /dev/null 2>&1; then
            echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨!"
            exit 1
          fi

      # API í…ŒìŠ¤íŠ¸
      - name: Test API endpoint
        run: |
          APP_URL=$(az webapp show \
            -g "$RESOURCE_GROUP" -n "${{ secrets.AZURE_WEBAPP_NAME }}" \
            --query "defaultHostName" -o tsv)
          
          echo "ğŸš— ì°¨ëŸ‰ ë“±ë¡ API í…ŒìŠ¤íŠ¸ ì¤‘..."
          
          # ê°„ë‹¨í•œ API í…ŒìŠ¤íŠ¸
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST "https://$APP_URL/api/v1/cars" \
            -H "Content-Type: application/json" \
            -d '{"carModelId": 1, "plateNo": "TEST123", "status": "í…ŒìŠ¤íŠ¸"}')
          
          if [ "$RESPONSE" = "201" ] || [ "$RESPONSE" = "400" ]; then
            echo "âœ… API í…ŒìŠ¤íŠ¸ ì„±ê³µ! (ì‘ë‹µ ì½”ë“œ: $RESPONSE)"
          else
            echo "âŒ API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨! (ì‘ë‹µ ì½”ë“œ: $RESPONSE)"
            exit 1
          fi

      # ë°°í¬ ì„±ê³µ ì•Œë¦¼
      - name: Deployment success notification
        if: success()
        run: |
          echo "ğŸ‰ ë°°í¬ ì„±ê³µ!"
          echo "App Service: ${{ secrets.AZURE_WEBAPP_NAME }}"
          echo "Image: $IMAGE_NAME:${{ steps.vars.outputs.TAG }}"
          echo "ë°°í¬ ì‹œê°„: $(date)"
